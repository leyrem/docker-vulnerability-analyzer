import streamlit as st
import pandas as pd
import altair as alt
import plotly.express as px
import json
from utils import get_distribution_cves_per_scanner, parse_unique_cves_field

# Page config
counter_all_pkgs = {}

st.set_page_config(
    page_title="Docker Image Vulnerability Analysis Dashboard",
    page_icon="üèÇ",
    layout="wide",
    initial_sidebar_state="expanded")

alt.themes.enable("dark")

df_reshaped = pd.DataFrame()
# Create dropdown widgets on a sidebar for users  to select data
with st.sidebar:
    st.title('üèÇ Docker Image Vulnerability Analysis Dashboard')
    
    # Select a category 
    image_name_list_n = ["Verified Images", "Sponsored Images", "Official Images"]
    selected_name_c = st.selectbox('Select a category of Docker images', image_name_list_n, index=len(image_name_list_n)-1)

    if selected_name_c == "Sponsored Images":
        df_reshaped = pd.read_csv('/root/thesis_crawler/imagesSponsored.csv')
    elif selected_name_c == "Official Images":
        df_reshaped = pd.read_csv('/root/thesis_crawler/imagesOfficial.csv')
    elif selected_name_c == "Verified Images":
        df_reshaped = pd.read_csv('/root/thesis_crawler/imagesVerified.csv')
        
    # Select a image name
    image_name_list = list(df_reshaped.Name.unique())
    selected_img_name = st.selectbox('Select an image name', image_name_list, index=len(image_name_list)-1)
    df_selected_name = df_reshaped[df_reshaped.Name == selected_img_name]


tab1, tab2 = st.tabs(["Image Information and Metadata", "Vulnerability Analysis"])

with tab1:
    st.header("Image Information and Metadata")
    
    st.subheader('Images Category', divider='rainbow')
    st.write(df_selected_name['Category'].iloc[0])
    st.subheader('Image Repository Name', divider='rainbow')
    st.write(df_selected_name['Repository'].iloc[0])
    st.subheader('Image Name', divider='rainbow')
    st.write(selected_img_name)
    st.subheader('Tags (versions) available for this image', divider='rainbow')
    for index, row in df_selected_name.iterrows(): 
        st.write(row['TagName'])
    st.subheader('Image Star Count (all tags)', divider='rainbow')
    st.write(df_selected_name['StarCount'].iloc[0])
    st.subheader('Image Pull Count (all tags)', divider='rainbow')
    st.write(df_selected_name['PullCount'].iloc[0])
    st.subheader('Image Subcategories', divider='rainbow')
    st.write(df_selected_name['SubCategories'].iloc[0])
    
    st.dataframe(df_selected_name)