import streamlit as st
import pandas as pd
import altair as alt
import json
import glob
import os
from concurrent.futures import ProcessPoolExecutor, as_completed
import itertools

from utils import get_distribution_cves_per_scanner, parse_unique_cves_field, extract_severity, get_cve_details

GENERAL_STATS_OFFICIAL = '/root/docker-vulnerability-analyzer/computeResults/out/general_stats_Official_Images.json'
GENERAL_STATS_VERIFIED = '/root/docker-vulnerability-analyzer/computeResults/out/general_stats_Verified_Images.json'
GENERAL_STATS_SPONSORED = '/root/docker-vulnerability-analyzer/computeResults/out/general_stats_Sponsored_Images.json'
GENERAL_STATS_ALL = '/root/docker-vulnerability-analyzer/computeResults/out/general_stats_All_Images.json'

DATA_RESULTS_OFFICIAL = '/root/docker-vulnerability-analyzer/computeResults/out/data_results_Official_Images.json'
DATA_RESULTS_VERIFIED = '/root/docker-vulnerability-analyzer/computeResults/out/data_results_Verified_Images.json'
DATA_RESULTS_SPONSORED = '/root/docker-vulnerability-analyzer/computeResults/out/data_results_Sponsored_Images.json'
DATA_RESULTS_ALL = '/root/docker-vulnerability-analyzer/computeResults/out/data_results_All_Images.json'

CVES_FREQ_OFFICIAL = '/root/docker-vulnerability-analyzer/computeResults/out/cves_freq_sorted_df_Official_Images.csv'
CVES_FREQ_VERIFIED = '/root/docker-vulnerability-analyzer/computeResults/out/cves_freq_sorted_df_Verified_Images.csv'
CVES_FREQ_SPONSORED = '/root/docker-vulnerability-analyzer/computeResults/out/cves_freq_sorted_df_Sponsored_Images.csv'
CVES_FREQ_ALL = '/root/docker-vulnerability-analyzer/computeResults/out/cves_freq_sorted_df_All_Images.csv'

PKGS_FREQ_OFFICIAL = '/root/docker-vulnerability-analyzer/computeResults/out/pkgs_freq_df_Official_Images.csv'
PKGS_FREQ_VERIFIED = '/root/docker-vulnerability-analyzer/computeResults/out/pkgs_freq_df_Verified_Images.csv'
PKGS_FREQ_SPONSORED = '/root/docker-vulnerability-analyzer/computeResults/out/pkgs_freq_df_Sponsored_Images.csv'
PKGS_FREQ_ALL = '/root/docker-vulnerability-analyzer/computeResults/out/pkgs_freq_df_All_Images.csv'

data_stats = None
data_cves_df = pd.DataFrame()
data_results = None

# Page config
st.set_page_config(
    page_title="Docker Large Scale Image Vulnerability Analysis Dashboard",
    page_icon="üèÇ",
    layout="wide",
    initial_sidebar_state="expanded")

alt.themes.enable("dark")

# Create dropdown widgets on a sidebar for users to select data
with st.sidebar:
    st.title('üèÇ Docker Large Scale Image Vulnerability Analysis Dashboard')

    # Select a image repo name
    image_name_list = ["All Images", "Verified Images", "Sponsored Images", "Official Images"]
    selected_name = st.selectbox('Select a set of Docker images', image_name_list, index=len(image_name_list)-1)

    file_path_stats = ""
    file_path_results = ""
    file_path_cves_freq = ""
    file_path_pkgs_freq = ""
    if selected_name == "All Images":
        file_path_stats = GENERAL_STATS_ALL
        file_path_results = DATA_RESULTS_ALL
        file_path_cves_freq = CVES_FREQ_ALL
        file_path_pkgs_freq = PKGS_FREQ_ALL
    elif selected_name == "Sponsored Images":
        file_path_stats = GENERAL_STATS_SPONSORED
        file_path_results = DATA_RESULTS_SPONSORED
        file_path_cves_freq = CVES_FREQ_SPONSORED
        file_path_pkgs_freq = PKGS_FREQ_SPONSORED
    elif selected_name == "Official Images":
        file_path_stats = GENERAL_STATS_OFFICIAL
        file_path_results = DATA_RESULTS_OFFICIAL
        file_path_cves_freq = CVES_FREQ_OFFICIAL
        file_path_pkgs_freq = PKGS_FREQ_OFFICIAL
    elif selected_name == "Verified Images":
        file_path_stats = GENERAL_STATS_VERIFIED
        file_path_results = DATA_RESULTS_VERIFIED
        file_path_cves_freq = CVES_FREQ_VERIFIED
        file_path_pkgs_freq = PKGS_FREQ_VERIFIED
        
    # Load Data
    with open(file_path_stats, 'r') as file:
        data_stats = json.load(file)
        
    with open(file_path_results, 'r') as file2:
        data_results = json.load(file2)
        
    data_cves_df = pd.read_csv(file_path_cves_freq)
    pkgs_freq_df = pd.read_csv(file_path_pkgs_freq)
    
                
tab1, tab2 = st.tabs(["Images Information and Metadata", "Vulnerability Analysis"])

with tab1:
    st.header("Images Information")

    st.metric(label = "Number of Docker images analysed", value=data_stats["number_images_analysed"])

with tab2:
    st.header("Vulnerability Analysis")
    
    tab2_1, tab2_2, tab2_3 = st.tabs(["Overall Vulnerability Landscape", "Detailed Unique Vulnerabilities", "Scanner Performance Analysis"])
    
    with tab2_2:
        # -----------------SHOW cves freq dataframe----------------------------
        st.write("Dataframe with the specific detected information per CVE ID")
        st.dataframe(data_cves_df)
        #------------------------------
    with tab2_1:
        st.subheader("Overall Vulnerability Landscape", divider='rainbow')
        
        st.metric(label = "Number of Docker images analysed", value=data_results["number_images_analysed"])
        
        if selected_name == "All Images":
            col1, col2, col3 = st.columns(3)
                 
            col1.metric(label ="Number of Official Images analysed", value=689)
            col2.metric(label ="Number of Verified Images analysed", value=702)
            col3.metric(label ="Number of Sponsored Images analysed", value=712)
            
        st.metric(label = "Number of total unique vulnerabilities found by all scanners", value=data_results["num_unique_vulnerabilities"])
        
        # -------- DONUT CHART WITH SEVERITY DISTRIBUTION
        categories = ["LOW VULNERABILITIES", "MEDIUM VULNERABILITIES", "HIGH VULNERABILITIES", "CRITICAL VULNERABILITIES", "UNASSIGNED VULNERABILITIES", "DIFFERING VULNERABILITIES"]
        values = [
            data_results["low_vulnerabilities"], 
            data_results["medium_vulnerabilitites"],
            data_results["high_vulnerabilities"],
            data_results["critical_vulnerabilitites"],
            data_results["unassigned_vulnerabilities"],
            data_results["differing_vulnerabilitites"],
        ]
        source = pd.DataFrame({"category": categories, "value": values})

        chart = alt.Chart(source).mark_arc(innerRadius=50).encode(
            theta=alt.Theta(field="value", type="quantitative"),
            color=alt.Color(field="category", type="nominal"),
        )
        st.altair_chart(chart, theme=None, use_container_width=True)
        # ----------------------
        #-------- Severity Distribution -----
        tot = data_results["num_unique_vulnerabilities"]
        col1, col2, col3 = st.columns(3)
                 
        col1.metric(label ="Number of LOW vulnerabilities", value=str(values[0]) + ' (' + str(round(values[0] / tot * 100, 1)) + '%)')
        col2.metric(label ="Number of MEDIUM vulnerabilities", value=str(values[1]) + ' (' + str(round(values[1] / tot * 100, 1)) + '%)')
        col3.metric(label ="Number of HIGH vulnerabilities", value=str(values[2]) + ' (' + str(round(values[2] / tot * 100, 1)) + '%)')
            
        col4, col5, col6 = st.columns(3)
                 
        col4.metric(label ="Number of CRITICAL vulnerabilities", value=str(values[3]) + ' (' + str(round(values[3] / tot * 100, 1)) + '%)')
        col5.metric(label ="Number of UNASSIGNED vulnerabilities", value=str(values[4]) + ' (' + str(round(values[4] / tot * 100, 1)) + '%)')
        col6.metric(label ="Number of DIFFERING vulnerabilities", value=str(values[5]) + ' (' + str(round(values[5] / tot * 100, 1)) + '%)')
        # -----------------------------------------
        # -------- DONUT CHART WITH fix DISTRIBUTION
        categories2 = ["FIXED VULNERABILITIES", "NOT FIXED VULNERABILITIES", "DIFFERENT STATUSES REPORTED VULNERABILITIES"]
        values2 = [
            data_results["fixed_vulnerabilities"], 
            data_results["not_fixed_vulnerabilities"],
            data_results["vulnerabilities_different_fix_status"],
        ]
        source2 = pd.DataFrame({"category": categories2, "value": values2})

        chart2 = alt.Chart(source2).mark_arc(innerRadius=50).encode(
            theta=alt.Theta(field="value", type="quantitative"),
            color=alt.Color(field="category", type="nominal"),
        )
        st.altair_chart(chart2, theme=None, use_container_width=True)
        # ----------------------
        #-------- fix Distribution -----
        col1, col2, col3 = st.columns(3)
                 
        col1.metric(label ="Number of FIXED vulnerabilities", value=str(values2[0]) + ' (' + str(round(values2[0] / tot * 100, 1)) + '%)')
        col2.metric(label ="Number of NOT FIXED vulnerabilities", value=str(values2[1]) + ' (' + str(round(values2[1] / tot * 100, 1)) + '%)')
        col3.metric(label ="Number of vulnerabilities with DIFFERENT (fix) statuses reported", value=str(values2[2]) + ' (' + str(round(values2[2] / tot * 100, 1)) + '%)')
        # -----------------------------------------
        # -------- CVEs images analysis ----------------
        st.markdown("General landscape of vulnerabilities in :red[all images analysed]")
        col1, col2, col3 = st.columns(3)
        col1.metric(label ="Average number of CVEs per image", value=round(data_stats["average_cves_per_image"], 2))
        col2.metric(label ="Median number of CVEs per image", value=data_stats["median_cves_per_image"])
        col3.metric(label ="Variance in the number of CVEs per image", value=round(data_stats["variance_cves_per_image"], 2))
            
        col4, col5 = st.columns(2)
        col4.metric(label ="Min number of CVEs found in an image", value=data_stats["min_value_cves_per_images"])
        col5.metric(label ="Max number of CVEs found in an image", value=data_stats["max_value_cves_per_image"])
        # --------------------------------
        # ---PKGS FREQ ------------------
        st.write("Dataframe with the unique packages affecting the unique CVEs and their counts (how many CVEs they affect)")
        st.dataframe(pkgs_freq_df)
        
    with tab2_3:
        
        # ------ Number of CVES found by scanner graph-------
        st.markdown("Number of :red[CVEs] found by scanner")
        
        scanners = ["Snyk", "Trivy", "Grype", "DockerScout", "JFrog"]
        values_cves_found = [
            data_results["Snyk_results"]["num_CVES_detected"],
            data_results["Trivy_results"]["num_CVES_detected"],
            data_results["Grype_results"]["num_CVES_detected"],
            data_results["DockerScout_results"]["num_CVES_detected"],
            data_results["JFrog_results"]["num_CVES_detected"],
        ]
        
        source_dist_scanners = pd.DataFrame({"scanners": scanners, "values": values_cves_found})
        chart_dist_cvess = alt.Chart(source_dist_scanners).mark_bar().encode(
            x='scanners:O',
            y="values:Q",
            color=alt.Color(field="scanners", type="nominal"),
        ).properties(width=100)
        st.altair_chart(chart_dist_cvess, theme="streamlit", use_container_width=True)
        #------------------
         # ------ Average number of CVEs per image found by scanner graph-------
        st.markdown("Average number of :red[CVEs per image] found by scanner")
        
        avg_values_cves_found = [
            round(data_results["Snyk_results"]["average_cves"], 2),
            round(data_results["Trivy_results"]["average_cves"], 2),
            round(data_results["Grype_results"]["average_cves"], 2),
            round(data_results["DockerScout_results"]["average_cves"], 2),
            round(data_results["JFrog_results"]["average_cves"], 2),
        ]
        
        source_dist_avg_scanners = pd.DataFrame({"scanners": scanners, "values": avg_values_cves_found})
        chart_dist_cvess_avg = alt.Chart(source_dist_avg_scanners).mark_bar().encode(
            x='scanners:O',
            y="values:Q",
            color=alt.Color(field="scanners", type="nominal"),
        ).properties(width=100)
        st.altair_chart(chart_dist_cvess_avg, theme="streamlit", use_container_width=True)
        #-----------------
        
        # --------------severities per scanner------------------
        sev_per_scanner = {
            "Snyk_results": {
                "low_vulns": data_results["Snyk_results"]["low_vulns"], 
                "medium_vulns": data_results["Snyk_results"]["medium_vulns"],  
                "high_vulns": data_results["Snyk_results"]["high_vulns"],
                "critical_vulns": data_results["Snyk_results"]["critical_vulns"],
                "unassigned_vulns": data_results["Snyk_results"]["unassigned_vulns"],  
            },
            "Trivy_results": {
                "low_vulns": data_results["Trivy_results"]["low_vulns"], 
                "medium_vulns": data_results["Trivy_results"]["medium_vulns"],  
                "high_vulns": data_results["Trivy_results"]["high_vulns"],
                "critical_vulns": data_results["Trivy_results"]["critical_vulns"],
                "unassigned_vulns": data_results["Trivy_results"]["unassigned_vulns"], 
            },
            "Grype_results": {
                "low_vulns": data_results["Grype_results"]["low_vulns"], 
                "medium_vulns": data_results["Grype_results"]["medium_vulns"],  
                "high_vulns": data_results["Grype_results"]["high_vulns"],
                "critical_vulns": data_results["Grype_results"]["critical_vulns"],
                "unassigned_vulns": data_results["Grype_results"]["unassigned_vulns"], 
            },
            "DockerScout_results": {
                "low_vulns": data_results["DockerScout_results"]["low_vulns"], 
                "medium_vulns": data_results["DockerScout_results"]["medium_vulns"],  
                "high_vulns": data_results["DockerScout_results"]["high_vulns"],
                "critical_vulns": data_results["DockerScout_results"]["critical_vulns"],
                "unassigned_vulns": data_results["DockerScout_results"]["unassigned_vulns"], 
            },
            "JFrog_results": {
                "low_vulns": data_results["JFrog_results"]["low_vulns"], 
                "medium_vulns": data_results["JFrog_results"]["medium_vulns"],  
                "high_vulns": data_results["JFrog_results"]["high_vulns"],
                "critical_vulns": data_results["JFrog_results"]["critical_vulns"],
                "unassigned_vulns": data_results["JFrog_results"]["unassigned_vulns"], 
            }
        }
        
        # Prepare data for the stacked bar chart
        data_sev_by_scanner = []
        for scanner in scanners:
            scanner_results = sev_per_scanner[f"{scanner}_results"]
            for var in ["low_vulns", "medium_vulns", "high_vulns", "critical_vulns", "unassigned_vulns"]:
                data_sev_by_scanner.append({"scanner": scanner, "variable": var, "value": scanner_results[var]})

        # Create DataFrame
        source_df_sev_by_scanner = pd.DataFrame(data_sev_by_scanner)
        
        chart_sev_by_scanner = alt.Chart(source_df_sev_by_scanner).mark_bar(size=15).encode(
            x=alt.X('scanner:N', title='Scanner', axis=alt.Axis(labelAngle=-45)),
            y=alt.Y('value:Q', title='Number of Vulnerabilities'),
            color='variable:N',
            column=alt.Column('variable:N', title='Severity', header=alt.Header(labelAngle=-45))
        ).properties(
            title="Vulnerabilities by Severity for Each Scanner",
            width=80  # Smaller width for even narrower bars
        ).configure_facet(
            spacing=20  # No spacing between facets
        ).configure_title(
            anchor='start'
        )

        st.altair_chart(chart_sev_by_scanner, theme="streamlit", use_container_width=False)
        #----------------
        
        # --------------fix per scanner------------------
        fix_per_scanner = {
            "Snyk_results": {
                "fixed_vulns": data_results["Snyk_results"]["fixed_vulns"], 
                "not_fixed_vulns": data_results["Snyk_results"]["not_fixed_vulns"], 
            },
            "Trivy_results": {
                "fixed_vulns": data_results["Trivy_results"]["fixed_vulns"], 
                "not_fixed_vulns": data_results["Trivy_results"]["not_fixed_vulns"],
            },
            "Grype_results": {
                "fixed_vulns": data_results["Grype_results"]["fixed_vulns"], 
                "not_fixed_vulns": data_results["Grype_results"]["not_fixed_vulns"],
            },
            "DockerScout_results": {
                "fixed_vulns": data_results["DockerScout_results"]["fixed_vulns"], 
                "not_fixed_vulns": data_results["DockerScout_results"]["not_fixed_vulns"],
            },
            "JFrog_results": {
                "fixed_vulns": data_results["JFrog_results"]["fixed_vulns"], 
                "not_fixed_vulns": data_results["JFrog_results"]["not_fixed_vulns"],
            }
        }
        
        # Prepare data for the stacked bar chart
        data_fix_by_scanner = []
        for scanner in scanners:
            scanner_results = fix_per_scanner[f"{scanner}_results"]
            for var in ["fixed_vulns", "not_fixed_vulns"]:
                data_sev_by_scanner.append({"scanner": scanner, "variable": var, "value": scanner_results[var]})

        # Create DataFrame
        source_df_fix_by_scanner = pd.DataFrame(data_fix_by_scanner)
        
        chart_fix_by_scanner = alt.Chart(source_df_fix_by_scanner).mark_bar(size=10).encode(  # size=10 for narrower bars
            x=alt.X('scanner:N', title='Scanner', axis=alt.Axis(labelAngle=-45)),
            y=alt.Y('value:Q', title='Number of Vulnerabilities'),
            color='variable:N',
            column=alt.Column('variable:N', title='Severity', header=alt.Header(labelAngle=-45))
        ).properties(
            title="Vulnerabilities by Severity for Each Scanner",
            width=10  # Smaller width for even narrower bars
        ).configure_facet(
            spacing=1  # Minimal spacing between facets
        ).configure_title(
            anchor='start'
        )

        st.altair_chart(chart_fix_by_scanner, theme="streamlit", use_container_width=True)
        #----------------
        
        # ------ Average efficacy by scanner graph-------
        st.markdown("Average :red[relative efficacy] by scanner")
        
        avg_effic_found = [
            data_results["Snyk_results"]["average_efficacy"],
            data_results["Trivy_results"]["average_efficacy"],
            data_results["Grype_results"]["average_efficacy"],
            data_results["DockerScout_results"]["average_efficacy"],
            data_results["JFrog_results"]["average_efficacy"],
        ]
        source_dist_avg_effic_scanners = pd.DataFrame({"scanners": scanners, "values": avg_effic_found})


        chart_effic = alt.Chart(source_dist_avg_effic_scanners).mark_bar().encode(
            x='values:Q',
            y=alt.Y('scanners:N', sort='-x')
        )

        st.altair_chart(chart_effic, theme="streamlit", use_container_width=True)
        #------------------
            
        with st.expander("Snyk detailed analysis results"):
            #-------- CVEs Distribution -----
            col1, col2, col3 = st.columns(3)
            col1.metric(label ="Average number of CVEs per image", value=round(data_results["Snyk_results"]["average_cves"], 2))
            col2.metric(label ="Median number of CVEs per image", value=data_results["Snyk_results"]["median_cves"])
            col3.metric(label ="Variance in the number of CVEs per image", value=round(data_results["Snyk_results"]["variance_cves"], 2))
                
            col4, col5 = st.columns(2)
            col4.metric(label ="Min number of CVEs found in an image", value=data_results["Snyk_results"]["min_cves"])
            col5.metric(label ="Max number of CVEs found in an image", value=data_results["Snyk_results"]["max_cves"])
            # -----------------------------------------
            
        with st.expander("Trivy detailed analysis results"):
            #-------- CVEs Distribution -----
            col1, col2, col3 = st.columns(3)
            col1.metric(label ="Average number of CVEs per image", value=round(data_results["Trivy_results"]["average_cves"], 2))
            col2.metric(label ="Median number of CVEs per image", value=data_results["Trivy_results"]["median_cves"])
            col3.metric(label ="Variance in the number of CVEs per image", value=round(data_results["Trivy_results"]["variance_cves"], 2))
                
            col4, col5 = st.columns(2)
            col4.metric(label ="Min number of CVEs found in an image", value=data_results["Trivy_results"]["min_cves"])
            col5.metric(label ="Max number of CVEs found in an image", value=data_results["Trivy_results"]["max_cves"])
            # -----------------------------------------
        
        with st.expander("Grype detailed analysis results"):
            #-------- CVEs Distribution -----
            col1, col2, col3 = st.columns(3)
            col1.metric(label ="Average number of CVEs per image", value=round(data_results["Grype_results"]["average_cves"], 2))
            col2.metric(label ="Median number of CVEs per image", value=data_results["Grype_results"]["median_cves"])
            col3.metric(label ="Variance in the number of CVEs per image", value=round(data_results["Grype_results"]["variance_cves"], 2))
                
            col4, col5 = st.columns(2)
            col4.metric(label ="Min number of CVEs found in an image", value=data_results["Grype_results"]["min_cves"])
            col5.metric(label ="Max number of CVEs found in an image", value=data_results["Grype_results"]["max_cves"])
            # -----------------------------------------

        with st.expander("JFrog detailed analysis results"):
            #-------- CVEs Distribution -----
            col1, col2, col3 = st.columns(3)
            col1.metric(label ="Average number of CVEs per image", value=round(data_results["JFrog_results"]["average_cves"], 2))
            col2.metric(label ="Median number of CVEs per image", value=data_results["JFrog_results"]["median_cves"])
            col3.metric(label ="Variance in the number of CVEs per image", value=round(data_results["JFrog_results"]["variance_cves"], 2))
                
            col4, col5 = st.columns(2)
            col4.metric(label ="Min number of CVEs found in an image", value=data_results["JFrog_results"]["min_cves"])
            col5.metric(label ="Max number of CVEs found in an image", value=data_results["JFrog_results"]["max_cves"])
            # -----------------------------------------
        
        with st.expander("DockerScout detailed analysis results"):
            #-------- CVEs Distribution -----
            col1, col2, col3 = st.columns(3)
            col1.metric(label ="Average number of CVEs per image", value=round(data_results["DockerScout_results"]["average_cves"], 2))
            col2.metric(label ="Median number of CVEs per image", value=data_results["DockerScout_results"]["median_cves"])
            col3.metric(label ="Variance in the number of CVEs per image", value=round(data_results["DockerScout_results"]["variance_cves"], 2))
                
            col4, col5 = st.columns(2)
            col4.metric(label ="Min number of CVEs found in an image", value=data_results["DockerScout_results"]["min_cves"])
            col5.metric(label ="Max number of CVEs found in an image", value=data_results["DockerScout_results"]["max_cves"])
            # -----------------------------------------
            
