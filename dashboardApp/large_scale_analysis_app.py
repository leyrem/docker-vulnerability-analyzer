import streamlit as st
import pandas as pd
import altair as alt
import plotly.express as px
import json
import glob
import os

from utils import get_distribution_cves_per_scanner, parse_unique_cves_field

DIR_OFFICIAL = '/Users/leyremonreal/Documents/Master/thesis/docker-vulnerability-analyzer/out/analysis/official/'
DIR_VERIFIED = '/Users/leyremonreal/Documents/Master/thesis/docker-vulnerability-analyzer/out/analysis/verified/'
DIR_SPONSORED = '/Users/leyremonreal/Documents/Master/thesis/docker-vulnerability-analyzer/out/analysis/sponsored/'

# Page config
st.set_page_config(
    page_title="Docker Large Scale Image Vulnerability Analysis Dashboard",
    page_icon="🏂",
    layout="wide",
    initial_sidebar_state="expanded")

alt.themes.enable("dark")

# Load data
df_official = pd.read_csv('/Users/leyremonreal/Documents/Master/thesis/thesis_crawler/imagesOfficial.csv')
df_verified = pd.read_csv('/Users/leyremonreal/Documents/Master/thesis/thesis_crawler/imagesVerified.csv')
df_sponsored = pd.read_csv('/Users/leyremonreal/Documents/Master/thesis/thesis_crawler/imagesSponsored.csv')


# Create dropdown widgets on a sidebar for users to select data
with st.sidebar:
    st.title('🏂 Docker Large Scale Image Vulnerability Analysis Dashboard')

    # Select a image repo name
    image_name_list = ["Official Images", "Verified Images", "Sponsored Images", "All Images"]
    selected_name = st.selectbox('Select a set of Docker images', image_name_list, index=len(image_name_list)-1)

    directory = ''
    if selected_name == "Official Images":
        directory = DIR_OFFICIAL
    elif selected_name == "Verified Images":
        directory = DIR_VERIFIED
    elif selected_name == "Sponsored Images":
        directory = DIR_SPONSORED

    df_cves_detected_all_scanners = pd.DataFrame()
    df_unique_cves = pd.DataFrame()

    if directory == '': # Case ALL IMAGES
        list_dirs = [DIR_OFFICIAL, DIR_VERIFIED, DIR_SPONSORED]

        for d in list_dirs:
            pattern = os.path.join(d, '*')
            for filename in glob.glob(pattern):
                if os.path.isfile(filename):
                    with open(filename) as file:
                        dataJSON = json.load(file)
                        
                    df1 = pd.json_normalize(dataJSON, 'cves_detected_all_scanners')
                    df2 = pd.json_normalize(dataJSON, 'unique_cves')
                    
                    df_cves_detected_all_scanners = pd.concat([df_cves_detected_all_scanners, df1], ignore_index=True)
                    df_unique_cves = pd.concat([df_unique_cves, df2], ignore_index=True)
    else:
        pattern = os.path.join(directory, '*')
        for filename in glob.glob(pattern):
            if os.path.isfile(filename):
                with open(filename) as file:
                    dataJSON = json.load(file)
                    
                df1 = pd.json_normalize(dataJSON, 'cves_detected_all_scanners')
                df2 = pd.json_normalize(dataJSON, 'unique_cves')
                df_cves_detected_all_scanners = pd.concat([df_cves_detected_all_scanners, df1], ignore_index=True)
                df_unique_cves = pd.concat([df_unique_cves, df2], ignore_index=True)
                
tab1, tab2 = st.tabs(["Image Information and Metadata", "Vulnerability Analysis"])

with tab1:
    st.header("Image Information and Metadata")
    
    # Display the filtered dataframe for debugging
    st.write("DataFrame CVES_detected_all_scanners:")
    st.dataframe(df_cves_detected_all_scanners)

    if len(df_unique_cves) > 0:
        st.write("DataFrame unique_cves:")
        st.write(df_unique_cves)
        
with tab2:
    st.header("Vulnerability Analysis")
    
    tab2_1, tab2_2, tab2_3 = st.tabs(["Overall Vulnerability Landscape", "Detailed Unique Vulnerabilities", "Scanner Performance Analysis"])
    
    with tab2_1:
        st.subheader("Overall Vulnerability Landscape", divider='rainbow') 
        
        
        unique_CVEs_all = {}
        
        for index, row in df_unique_cves.iterrows():
            detection_rate = row['detection_rate']
            scanner_cve_inf = row['scanner_cve_info']
            scanner_cve_inf_df = parse_unique_cves_field(scanner_cve_inf)
            cve_id = scanner_cve_inf_df['cve_id'].iloc[0]
            
            if cve_id in unique_CVEs_all:
                unique_CVEs_all[cve_id].append(scanner_cve_inf_df)
            else:
                unique_CVEs_all[cve_id] = [scanner_cve_inf_df]
            
        st.metric(label="Total number of unique CVEs found", value=len(unique_CVEs_all))
        cves_freq_df = pd.DataFrame(columns=['CVE ID', 'Images Present Count'])
        
        for key, value in unique_CVEs_all.items():
            single_row = pd.DataFrame([{'CVE ID': key, 'Images Present Count': len(value)}])
            cves_freq_df = pd.concat([cves_freq_df, single_row], ignore_index=True)
            
        cves_freq_df_sorted = cves_freq_df.sort_values(by='Images Present Count', ascending=False)
        st.dataframe(cves_freq_df_sorted)