package main

import (
	"bufio"
	"fmt"
	"io"
	"log"
	"os"

	"github.com/leyrem/docker-vulnerability-analyzer/analyser"
	"github.com/leyrem/docker-vulnerability-analyzer/utils"
)

const (
	LOG_FILE        = "/root/docker-vulnerability-analyzer/out/log/logVerifiedAnalysis.log"
	SOURCE_DIR      = "/root/docker-vulnerability-analyzer/out/verified/"
	ERROR_TXT_FILE  = "/root/docker-vulnerability-analyzer/out/errors/errorAnalyserVerified.txt"
	OUTPUT_DIR      = "/root/docker-vulnerability-analyzer/out/analysis/verified/"
	CSV_FILE        = "/root/thesis_crawler/imagesVerified.csv"
	IMAGES_CATEGORY = "verified"
)

func main() {

	logFile, err := os.OpenFile(LOG_FILE, os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0644)
	if err != nil {
		panic(err)
	}
	defer logFile.Close()
	// Create a MultiWriter to write to both stdout and the file
	mw := io.MultiWriter(os.Stdout, logFile)
	log.SetOutput(mw)

	images, err := utils.ReadCSV(CSV_FILE, IMAGES_CATEGORY)
	if err != nil {
		panic(err)
	}

	fileErr, err := os.Create(ERROR_TXT_FILE)
	if err != nil {
		panic(fmt.Errorf("error opening error file: %v", err))
	}
	defer fileErr.Close()

	// Create a writer that will write to the file
	writer := bufio.NewWriter(fileErr)

	for _, img := range images[2:] {

		outputFileName := OUTPUT_DIR + img + "_analysis.json"
		err = analyser.GetListCVEsAllScanners(SOURCE_DIR, img, outputFileName)
		if err != nil {
			errMsg := img + " ----------- " + err.Error()
			_, err := writer.WriteString(errMsg + "\n")
			if err != nil {
				fmt.Println("Error writing to error file:", err)
				return
			}
			err = writer.Flush()
			if err != nil {
				fmt.Println("Error flushing error file:", err)
				return
			}
		}
	}

	// Flush the buffer to ensure all data is written to the file
	err = writer.Flush()
	if err != nil {
		fmt.Println("Error flusing error file:", err)
		return
	}

}
